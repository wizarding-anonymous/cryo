#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ User Service

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ User Service"
echo "========================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ k6
if ! command -v k6 &> /dev/null; then
    echo "‚ùå k6 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ k6 –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤:"
    echo "   ‚Ä¢ macOS: brew install k6"
    echo "   ‚Ä¢ Ubuntu: sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69"
    echo "            echo 'deb https://dl.k6.io/deb stable main' | sudo tee /etc/apt/sources.list.d/k6.list"
    echo "            sudo apt-get update && sudo apt-get install k6"
    echo "   ‚Ä¢ Windows: choco install k6"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ User Service
BASE_URL=${BASE_URL:-"http://localhost:3001"}
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å User Service –Ω–∞ $BASE_URL..."

if ! curl -s "$BASE_URL/health" > /dev/null; then
    echo "‚ùå User Service –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ $BASE_URL"
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω:"
    echo "   docker-compose -f docker-compose.simple.yml up -d"
    exit 1
fi

echo "‚úÖ User Service –¥–æ—Å—Ç—É–ø–µ–Ω"

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
mkdir -p results
cd "$(dirname "$0")"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞
run_test() {
    local test_name=$1
    local test_file=$2
    local description=$3
    
    echo ""
    echo "üìä –ó–∞–ø—É—Å–∫ $test_name"
    echo "   –û–ø–∏—Å–∞–Ω–∏–µ: $description"
    echo "   –§–∞–π–ª: $test_file"
    echo "   –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: $(date)"
    echo ""
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç —Å –≤—ã–≤–æ–¥–æ–º –≤ —Ñ–∞–π–ª –∏ –∫–æ–Ω—Å–æ–ª—å
    k6 run --out json=results/${test_name}-$(date +%Y%m%d-%H%M%S).json $test_file
    
    echo ""
    echo "‚úÖ $test_name –∑–∞–≤–µ—Ä—à–µ–Ω"
    echo "   –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è: $(date)"
}

# –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–µ—Å—Ç–æ–≤
echo ""
echo "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
echo "1) –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç (Load Test) - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ–¥ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π"
echo "2) –°—Ç—Ä–µ—Å—Å —Ç–µ—Å—Ç (Stress Test) - –ø–æ–∏—Å–∫ —Ç–æ—á–∫–∏ –æ—Ç–∫–∞–∑–∞ —Å–∏—Å—Ç–µ–º—ã"
echo "3) –û–±–∞ —Ç–µ—Å—Ç–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ"
echo "4) –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (—Å–æ–∫—Ä–∞—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)"
echo ""

read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (1-4): " choice

case $choice in
    1)
        run_test "load-test" "k6-load-test.js" "–ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ 10K –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
        ;;
    2)
        run_test "stress-test" "k6-stress-test.js" "–°—Ç—Ä–µ—Å—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ 50K –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
        ;;
    3)
        run_test "load-test" "k6-load-test.js" "–ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ 10K –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
        echo ""
        echo "‚è≥ –ü–∞—É–∑–∞ 30 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏..."
        sleep 30
        run_test "stress-test" "k6-stress-test.js" "–°—Ç—Ä–µ—Å—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ 50K –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
        ;;
    4)
        echo "üèÉ‚Äç‚ôÇÔ∏è –ó–∞–ø—É—Å–∫ –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞ (2 –º–∏–Ω—É—Ç—ã)..."
        k6 run --duration 2m --vus 100 k6-load-test.js
        ;;
    *)
        echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
        exit 1
        ;;
esac

echo ""
echo "üéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìÅ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ results/"
echo "üìä –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "   ‚Ä¢ k6 cloud —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω k6 cloud)"
echo "   ‚Ä¢ Grafana dashboard (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)"
echo "   ‚Ä¢ JSON —Ñ–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ results/"
echo ""
echo "üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "   ‚Ä¢ –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
echo "   ‚Ä¢ –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Ä–µ—Å—É—Ä—Å—ã —Å–∏—Å—Ç–µ–º—ã –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
echo "   ‚Ä¢ –°—Ä–∞–≤–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
echo ""