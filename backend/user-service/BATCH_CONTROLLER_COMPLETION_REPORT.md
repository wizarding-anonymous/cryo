# –û—Ç—á–µ—Ç –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ 3.2: –°–æ–∑–¥–∞–Ω–∏–µ BatchController –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö API

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã

### 1. –°–æ–∑–¥–∞–Ω InternalServiceGuard
- **–§–∞–π–ª**: `src/common/guards/internal-service.guard.ts`
- **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**:
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–µ–π (Authorization Bearer –∏ x-api-key)
  - IP whitelist –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤
  - –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
  - –†–µ–∂–∏–º—ã development/production —Å —Ä–∞–∑–Ω—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∫—Å–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (x-forwarded-for, x-real-ip)

### 2. –û–±–Ω–æ–≤–ª–µ–Ω BatchController
- **–§–∞–π–ª**: `src/user/batch.controller.ts`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
  - –î–æ–±–∞–≤–ª–µ–Ω `@UseGuards(InternalServiceGuard)` –¥–ª—è –∑–∞—â–∏—Ç—ã –≤—Å–µ—Ö endpoints
  - –î–æ–±–∞–≤–ª–µ–Ω—ã `@ApiSecurity` –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –¥–ª—è Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
  - –û–±–Ω–æ–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö DTO

### 3. –°–æ–∑–¥–∞–Ω—ã DTO —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- **BatchCreateUsersDto**: –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **BatchUpdateUsersDto**: –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
- **BatchUserIdsDto**: –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –º–∞—Å—Å–∏–≤–æ–º ID
- **BatchProcessingOptionsDto**: –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- **env.validation.ts**: –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- **common.module.ts**: —ç–∫—Å–ø–æ—Ä—Ç InternalServiceGuard

### 5. –°–æ–∑–¥–∞–Ω—ã —Ç–µ—Å—Ç—ã
- **internal-service.guard.spec.ts**: –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä unit —Ç–µ—Å—Ç–æ–≤ –¥–ª—è guard
- –ü–æ–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### 6. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **guards/README.md**: –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é guard
- **dto/README.md**: –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ DTO –∏ –ø—Ä–∏–º–µ—Ä—ã API –≤—ã–∑–æ–≤–æ–≤

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ú–µ—Ç–æ–¥—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
1. **API Keys** - —á–µ—Ä–µ–∑ Authorization Bearer –∏–ª–∏ x-api-key –∑–∞–≥–æ–ª–æ–≤–∫–∏
2. **IP Whitelist** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö IP –∞–¥—Ä–µ—Å–æ–≤
3. **Internal Headers** - —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
4. **Development Mode** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è localhost –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Å–µ—Ç–µ–π

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```env
INTERNAL_API_KEYS=auth-service-key,game-catalog-key,payment-service-key
INTERNAL_ALLOWED_IPS=127.0.0.1,::1,192.168.1.0/24
INTERNAL_SERVICE_SECRET=user-service-internal-secret
```

## üìã API Endpoints

–í—Å–µ endpoints –∑–∞—â–∏—â–µ–Ω—ã InternalServiceGuard:

- `POST /batch/users/create` - –º–∞—Å—Å–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `GET /batch/users/lookup` - –º–∞—Å—Å–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ ID
- `PATCH /batch/users/update` - –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- `PATCH /batch/users/last-login` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—Ö–æ–¥–∞
- `DELETE /batch/users/soft-delete` - –º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã InternalServiceGuard:
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è API –∫–ª—é—á–µ–π
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ IP –∞–¥—Ä–µ—Å–æ–≤  
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- ‚úÖ –†–µ–∂–∏–º—ã development/production
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –†–∞–±–æ—Ç–∞ —Å –ø—Ä–æ–∫—Å–∏

### –ü—Ä–∏–º–µ—Ä—ã –≤—ã–∑–æ–≤–æ–≤:

```bash
# –° API –∫–ª—é—á–æ–º
curl -H "Authorization: Bearer auth-service-key" \
  http://localhost:3001/batch/users/lookup?ids=uuid1,uuid2

# –° x-api-key
curl -H "x-api-key: game-catalog-key" \
  http://localhost:3001/batch/users/create \
  -d '{"users": [...]}'

# –° –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
curl -H "x-internal-service: user-service-internal-secret" \
  http://localhost:3001/batch/users/update \
  -d '{"updates": [...]}'
```

## üìä –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 8.1 ‚úÖ
> "–ö–û–ì–î–ê Auth Service –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¢–û–ì–î–ê —Å–∏—Å—Ç–µ–º–∞ –î–û–õ–ñ–ù–ê –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ REST API endpoints"

- –°–æ–∑–¥–∞–Ω—ã –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ endpoints –¥–ª—è –≤—Å–µ—Ö batch –æ–ø–µ—Ä–∞—Ü–∏–π
- InternalServiceGuard –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –¥–ª—è Auth Service

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 8.3 ‚úÖ  
> "–ö–û–ì–î–ê Payment Service –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ –¢–û–ì–î–ê —Å–∏—Å—Ç–µ–º–∞ –î–û–õ–ñ–ù–ê –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–∏–ª–ª–∏–Ω–≥–∞"

- Batch endpoints –ø–æ–∑–≤–æ–ª—è—é—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ó–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ API –∫–ª—é—á–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –¥–ª—è Payment Service

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ó–∞–¥–∞—á–∞ **3.2 "–°–æ–∑–¥–∞–Ω–∏–µ BatchController –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö API"** –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–ø–æ–ª–Ω–µ–Ω–∞:

- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã endpoints –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (/batch/users/create, /batch/users/lookup)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω InternalServiceGuard –¥–ª—è –∑–∞—â–∏—Ç—ã –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö API
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã DTO –¥–ª—è batch –æ–ø–µ—Ä–∞—Ü–∏–π —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- ‚úÖ –û–±–µ—Å–ø–µ—á–µ–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º 8.1 –∏ 8.3

BatchController –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –¥—Ä—É–≥–∏–º–∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏ –≤ –∑–∞—â–∏—â–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.