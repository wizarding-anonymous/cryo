# Library Service E2E Tests

Рефакторированные e2e тесты для микросервиса library с правильной архитектурой и полноценными клиентами внешних сервисов.

## Структура тестов

### Основные файлы тестов
- `library.e2e-spec.ts` - Основная функциональность библиотеки
- `performance.e2e-spec.ts` - Тесты производительности и нагрузки
- `search-filtering.e2e-spec.ts` - Тесты поиска и фильтрации

### Базовые классы и утилиты
- `e2e-test-base.ts` - Базовый класс для всех e2e тестов
- `test-app.module.ts` - Модуль приложения для тестов
- `test-setup.ts` - Настройка окружения для тестов

### Моки и помощники
- `mocks/updated-external-services.mock.ts` - Моки внешних сервисов
- `mocks/redis.mock.ts` - Мок Redis для тестов
- `helpers/test-users.ts` - Тестовые пользователи
- `controllers/test-health.controller.ts` - Контроллер для health проверок

## Особенности рефакторинга

### Правильные клиенты внешних сервисов
- **UserServiceClient** - Полноценный клиент для user-service с circuit breaker
- **GameCatalogClient** - Клиент для game-catalog-service с retry логикой
- **PaymentServiceClient** - Клиент для payment-service с обработкой ошибок

### Реалистичные моки
- Моки соответствуют реальным API контрактам
- Поддержка различных сценариев (успех, ошибки, таймауты)
- Возможность настройки поведения для конкретных тестов

### Базовый класс E2ETestBase
- Централизованная настройка тестового окружения
- Управление жизненным циклом приложения
- Утилиты для работы с тестовыми данными
- Автоматическая очистка данных между тестами

## Запуск тестов

```bash
# Все e2e тесты
npm run test:e2e

# Конкретный файл тестов
npm run test:e2e -- library.e2e-spec.ts

# Тесты с покрытием
npm run test:e2e:cov

# Тесты с Docker окружением
npm run test:e2e:docker
```

## Конфигурация

Тесты используют отдельную тестовую базу данных и in-memory кэш для изоляции от production окружения.

### Переменные окружения для тестов
- `DATABASE_HOST=127.0.0.1`
- `DATABASE_PORT=5434`
- `DATABASE_NAME=library_db`
- `REDIS_HOST=127.0.0.1`
- `REDIS_PORT=6379`

## Покрытие тестами

Тесты покрывают:
- ✅ Основную функциональность библиотеки
- ✅ Поиск и фильтрацию
- ✅ Производительность и нагрузку
- ✅ Обработку ошибок
- ✅ Безопасность и авторизацию
- ✅ Интеграцию с внешними сервисами
- ✅ Health проверки

## Архитектурные улучшения

1. **Модульность** - Каждый тест изолирован и может выполняться независимо
2. **Переиспользование** - Базовый класс устраняет дублирование кода
3. **Реалистичность** - Моки соответствуют реальным сервисам
4. **Производительность** - Оптимизированные запросы и кэширование
5. **Надежность** - Правильная обработка ошибок и edge cases