# Auth Service - Troubleshooting Guide

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–Ω–∞–ª–∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º, –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ Auth Service, –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Ö —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é.

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

### 1. Race Condition –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Å–µ—Å—Å–∏—è–º–∏

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `src/auth/auth.service.ts:158-170`

```typescript
// –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥
const removedSessionsCount = await this.sessionService.enforceSessionLimit(user.id, this.maxSessionsPerUser);
// ... –¥—Ä—É–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ...
const session = await this.sessionService.createSession({...});
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ª–∏–º–∏—Ç–∞ —Å–µ—Å—Å–∏–π –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ race condition, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ª–æ–≥–∏–Ω–∏—Ç—Å—è —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—é –ª–∏–º–∏—Ç–∞ —Å–µ—Å—Å–∏–π.

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üî¥ –í—ã—Å–æ–∫–∞—è

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è DoS –∞—Ç–∞–∫–∞ —á–µ—Ä–µ–∑ —Å–æ–∑–¥–∞–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π
- –ù–∞—Ä—É—à–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

**–†–µ—à–µ–Ω–∏–µ**:
```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
const lockKey = `session_limit:${user.id}`;
await this.redisService.acquireLock(lockKey, 5000); // 5 —Å–µ–∫—É–Ω–¥
try {
  const removedSessionsCount = await this.sessionService.enforceSessionLimit(user.id, this.maxSessionsPerUser);
  const session = await this.sessionService.createSession({...});
  return session;
} finally {
  await this.redisService.releaseLock(lockKey);
}
```

---

### 2. –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `src/entities/session.entity.ts:20-24`

```typescript
// –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥
@Column({ type: 'text' })
accessToken: string;

@Column({ type: 'text' })
refreshToken: string;
```

**–ü—Ä–æ–±–ª–µ–º–∞**: Access –∏ refresh —Ç–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ –ë–î –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–æ–ª—É—á–∏—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º —Ç–æ–∫–µ–Ω–∞–º.

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üî¥ –í—ã—Å–æ–∫–∞—è

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –ü–æ–ª–Ω–∞—è –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–µ—Å—Å–∏–π –ø—Ä–∏ —É—Ç–µ—á–∫–µ –ë–î
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–æ–∑–≤–∞—Ç—å —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
- –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ**:
```typescript
// –•—Ä–∞–Ω–∏—Ç—å —Ö–µ—à–∏ —Ç–æ–∫–µ–Ω–æ–≤ –≤–º–µ—Å—Ç–æ —Å–∞–º–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
@Column({ type: 'varchar', length: 64 })
accessTokenHash: string;

@Column({ type: 'varchar', length: 64 })
refreshTokenHash: string;

// –í —Å–µ—Ä–≤–∏—Å–µ
private hashToken(token: string): string {
  return createHash('sha256').update(token).digest('hex');
}
```

---

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –≤ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö logout

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `src/auth/auth.service.ts:240-255`

```typescript
// –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥
const session = await this.sessionService.getSessionByAccessToken(accessToken);
if (session) {
  await this.sessionService.invalidateSession(session.id);
}
await this.tokenService.blacklistToken(accessToken, userId, 'logout');
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è blacklistToken –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –æ—à–∏–±–∫–æ–π –ø–æ—Å–ª–µ invalidateSession, —Ç–æ–∫–µ–Ω –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º, –Ω–æ —Å–µ—Å—Å–∏—è –±—É–¥–µ—Ç –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞.

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üî¥ –í—ã—Å–æ–∫–∞—è

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –ù–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏ –∏ —Ç–æ–∫–µ–Ω–∞–º–∏
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è "–º–µ—Ä—Ç–≤—ã—Ö" —Ç–æ–∫–µ–Ω–æ–≤
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ**:
```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
const session = await this.sessionService.getSessionByAccessToken(accessToken);
if (session) {
  try {
    await this.tokenService.blacklistToken(accessToken, userId, 'logout');
    await this.sessionService.invalidateSession(session.id);
  } catch (error) {
    // –ö–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ —Å–µ—Å—Å–∏—è –±—ã–ª–∞ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–∞
    await this.tokenService.removeFromBlacklist(accessToken);
    throw error;
  }
}
```

---

### 4. –£—è–∑–≤–∏–º–æ—Å—Ç—å –∫ JWT Token Fixation

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `src/token/token.service.ts:280-295`

```typescript
// –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥
const newTokens = await this.generateTokens({...});
await this.blacklistToken(refreshToken, userId, 'refresh', {...});
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –¥–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç–∞—Ä–æ–≥–æ refresh —Ç–æ–∫–µ–Ω–∞. –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–µ—Ä–≤–µ—Ç—Å—è, —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º –≤–º–µ—Å—Ç–µ —Å –Ω–æ–≤—ã–º.

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üî¥ –í—ã—Å–æ–∫–∞—è

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ –∏ –Ω–æ–≤–æ–≥–æ refresh —Ç–æ–∫–µ–Ω–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞ —Ä–æ—Ç–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å replay –∞—Ç–∞–∫

**–†–µ—à–µ–Ω–∏–µ**:
```typescript
// –°–Ω–∞—á–∞–ª–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω, –∑–∞—Ç–µ–º –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π
await this.blacklistToken(refreshToken, userId, 'refresh', {...});
try {
  const newTokens = await this.generateTokens({...});
  return newTokens;
} catch (error) {
  // –ö–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω
  await this.removeFromBlacklist(refreshToken);
  throw error;
}
```

---

## üü° –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ê–†–•–ò–¢–ï–ö–¢–£–†–´

### 5. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `src/auth/auth.service.ts:75-125`

```typescript
// –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥
const newUser = await this.userServiceClient.createUser({...});
const tokens = await this.generateTokens(newUser);
const session = await this.sessionService.createSession({...});
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –æ—à–∏–±–∫–æ–π, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ —Å–º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üü° –°—Ä–µ–¥–Ω—è—è

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –ù–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- "–ó–∞–≤–∏—Å—à–∏–µ" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—Ö–æ–¥–∞
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫

**–†–µ—à–µ–Ω–∏–µ**:
```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Saga pattern –∏–ª–∏ –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
const sagaId = generateSagaId();
try {
  const newUser = await this.userServiceClient.createUser({...}, sagaId);
  const tokens = await this.generateTokens(newUser);
  const session = await this.sessionService.createSession({...});
  await this.sagaService.complete(sagaId);
  return result;
} catch (error) {
  await this.sagaService.compensate(sagaId);
  throw error;
}
```

---

### 6. –ù–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–æ–≤

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `src/token/token.service.ts:85-95`

```typescript
// –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥
await this.authDatabaseService.blacklistToken(...);
await this.redisService.blacklistToken(token, ttl);
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É Redis –∏ PostgreSQL. –¢–æ–∫–µ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ –æ–¥–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –Ω–æ –Ω–µ –≤ –¥—Ä—É–≥–æ–º.

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üü° –°—Ä–µ–¥–Ω—è—è

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –ù–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∫—ç—à–µ–º –∏ –ë–î
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å —Ç–æ–∫–µ–Ω–∞–º–∏

**–†–µ—à–µ–Ω–∏–µ**:
```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–≤—É—Ö—Ñ–∞–∑–Ω—ã–π –∫–æ–º–º–∏—Ç –∏–ª–∏ eventual consistency
async blacklistToken(token: string, userId: string, reason: string) {
  const transaction = await this.startDistributedTransaction();
  try {
    await this.authDatabaseService.blacklistToken(..., transaction);
    await this.redisService.blacklistToken(token, ttl, transaction);
    await transaction.commit();
  } catch (error) {
    await transaction.rollback();
    throw error;
  }
}
```

---

### 7. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã AuthService

**–ü—Ä–æ–±–ª–µ–º–∞**: –û–ø–µ—Ä–∞—Ü–∏–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –ª–æ–≥–∏–Ω–∞ –∏ logout –Ω–µ —è–≤–ª—è—é—Ç—Å—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º–∏, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üü° –°—Ä–µ–¥–Ω—è—è

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –ù–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö —Å–±–æ—è—Ö
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

**–†–µ—à–µ–Ω–∏–µ**:
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –∫–ª—é—á–∏
async register(registerDto: RegisterDto, idempotencyKey: string) {
  const existingOperation = await this.getOperation(idempotencyKey);
  if (existingOperation) {
    return existingOperation.result;
  }
  
  const result = await this.performRegistration(registerDto);
  await this.saveOperation(idempotencyKey, result);
  return result;
}
```

---

## üü† –ü–†–û–ë–õ–ï–ú–´ –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò –ò –ù–ê–î–ï–ñ–ù–û–°–¢–ò

### 8. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –≤ –∫—ç—à–µ

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `src/common/http-client/user-service.client.ts:35`

```typescript
// –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥
private readonly userCache = new Map<string, { user: User | null; timestamp: number }>();
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö—ç—à –Ω–µ –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ —Ä–∞–∑–º–µ—Ä—É –∏ –º–æ–∂–µ—Ç —Ä–∞—Å—Ç–∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ.

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üü† –ù–∏–∑–∫–∞—è

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –£—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –î–µ–≥—Ä–∞–¥–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –í–æ–∑–º–æ–∂–Ω—ã–π OutOfMemory

**–†–µ—à–µ–Ω–∏–µ**:
```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LRU –∫—ç—à —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
private readonly userCache = new LRUCache<string, CacheEntry>({
  max: 10000, // –º–∞–∫—Å–∏–º—É–º 10k –∑–∞–ø–∏—Å–µ–π
  ttl: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç TTL
});
```

---

### 9. –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º –ø—É—Ç–∏

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `src/auth/auth.service.ts:110`

```typescript
// –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥
void this.eventBusService.publishUserRegisteredEvent(...);
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –•–æ—Ç—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `void`, –≤–Ω—É—Ç—Ä–∏ publishUserRegisteredEvent –º–æ–≥—É—Ç –±—ã—Ç—å –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üü† –ù–∏–∑–∫–∞—è

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –í–æ–∑–º–æ–∂–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã
- –ü–ª–æ—Ö–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

**–†–µ—à–µ–Ω–∏–µ**:
```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â—É—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
setImmediate(() => {
  this.eventBusService.publishUserRegisteredEvent(...);
});
```

---

### 10. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ graceful degradation

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: –í—Å–µ HTTP –∫–ª–∏–µ–Ω—Ç—ã

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (User Service, Security Service) —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–∞–∑–∞—Ç—å –≤ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏ –≤–º–µ—Å—Ç–æ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üü† –ù–∏–∑–∫–∞—è

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
- –ü–æ–ª–Ω—ã–π –æ—Ç–∫–∞–∑ —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ü–ª–æ—Ö–∞—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å
- –ö–∞—Å–∫–∞–¥–Ω—ã–µ —Å–±–æ–∏

**–†–µ—à–µ–Ω–∏–µ**:
```typescript
// –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã
async findByEmail(email: string): Promise<User | null> {
  try {
    return await this.userServiceClient.findByEmail(email);
  } catch (error) {
    if (this.isServiceUnavailable(error)) {
      // Fallback –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∫—ç—à—É –∏–ª–∏ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–µ
      return this.fallbackUserLookup(email);
    }
    throw error;
  }
}
```

---

## üîß –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π) - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
1. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ë–î
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Å–µ—Å—Å–∏–π
3. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π logout
4. ‚úÖ –£—Å—Ç—Ä–∞–Ω–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç—å Token Fixation

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í—ã—Å–æ–∫–∏–π) - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏
5. ‚è≥ –í–Ω–µ–¥—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
6. ‚è≥ –û–±–µ—Å–ø–µ—á–∏—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å Redis/PostgreSQL
7. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–°—Ä–µ–¥–Ω–∏–π) - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞
8. ‚è≥ –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∫—ç—à–µ–π
9. ‚è≥ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
10. ‚è≥ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å graceful degradation

---

## üìä –ú–ï–¢–†–ò–ö–ò –î–õ–Ø –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–Ω–µ–¥—Ä–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏:

- **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–æ–≤**: –ü—Ä–æ—Ü–µ–Ω—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –º–µ–∂–¥—É Redis –∏ PostgreSQL
- **Race conditions**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–π
- **–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞**: –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–û—à–∏–±–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫–∞—Ç–æ–≤ –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–π
- **–†–∞–∑–º–µ—Ä –∫—ç—à–µ–π**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –∫—ç—à–∞–º–∏
- **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤**: Uptime –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

---

## üö® –≠–ö–°–¢–†–ï–ù–ù–´–ï –ü–†–û–¶–ï–î–£–†–´

### –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤:
1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
3. –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Redis –∏ –ë–î
4. –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ race condition:
1. –í—Ä–µ–º–µ–Ω–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
3. –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤ - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏

### –ü—Ä–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ Redis/PostgreSQL:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
2. –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å Redis –∏ —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å –ë–î
3. –ü–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É Redis

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 2025-10-11*  
*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-10-11*  
*–í–µ—Ä—Å–∏—è: 1.0*