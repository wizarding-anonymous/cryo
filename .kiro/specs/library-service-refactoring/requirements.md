# Требования к рефакторингу Library Service после миграции Auth Service

## Введение

После успешной миграции функционала аутентификации в отдельный Auth Service, Library Service требует комплексного рефакторинга для удаления устаревшего auth кода, оптимизации интеграции с новым Auth Service и улучшения общей архитектуры. Сервис должен сосредоточиться исключительно на управлении библиотеками игр пользователей.

## Глоссарий

- **Library Service**: Микросервис для управления библиотеками игр пользователей
- **Auth Service**: Новый отдельный микросервис аутентификации
- **User Service**: Микросервис управления пользователями (уже прошел рефакторинг)
- **Game Catalog Service**: Микросервис каталога игр
- **Payment Service**: Микросервис платежей
- **Redis**: Общий кэш для всех микросервисов
- **API Gateway**: Единая точка входа для всех API запросов

## Требования

### Требование 1

**Пользовательская история:** Как разработчик, я хочу чтобы Library Service содержал только код управления библиотеками, чтобы архитектура была чистой и понятной.

#### Критерии приемки

1. КОГДА проверяется код сервиса ТОГДА Library Service НЕ ДОЛЖЕН содержать auth модуль
2. КОГДА анализируются зависимости ТОГДА Library Service НЕ ДОЛЖЕН содержать JWT, passport или auth-related пакеты
3. КОГДА просматриваются контроллеры ТОГДА Library Service НЕ ДОЛЖЕН содержать auth endpoints
4. ЕСЛИ найдены остатки auth кода ТОГДА Library Service ДОЛЖЕН их полностью удалить

### Требование 2

**Пользовательская история:** Как Auth Service, я хочу эффективно валидировать токены для Library Service, чтобы обеспечить безопасный доступ к библиотекам.

#### Критерии приемки

1. КОГДА пользователь обращается к библиотеке ТОГДА Library Service ДОЛЖЕН валидировать JWT токен через Auth Service
2. КОГДА токен валиден ТОГДА Library Service ДОЛЖЕН извлекать userId из токена за < 10ms
3. КОГДА токен невалиден ТОГДА Library Service ДОЛЖЕН возвращать ошибку 401
4. ЕСЛИ Auth Service недоступен ТОГДА Library Service ДОЛЖЕН использовать локальную валидацию JWT

### Требование 3

**Пользовательская история:** Как пользователь, я хочу чтобы мой доступ к библиотеке работал быстро и надежно после изменений в архитектуре.

#### Критерии приемки

1. КОГДА пользователь открывает библиотеку ТОГДА Library Service ДОЛЖЕН вернуть данные за < 200ms
2. КОГДА пользователь ищет игры ТОГДА Library Service ДОЛЖЕН использовать оптимизированные индексы
3. КОГДА происходит добавление игры ТОГДА Library Service ДОЛЖЕН обновить кэш автоматически
4. ЕСЛИ база данных недоступна ТОГДА Library Service ДОЛЖЕН возвращать кэшированные данные

### Требование 4

**Пользовательская история:** Как Payment Service, я хочу эффективно добавлять игры в библиотеки после успешных покупок.

#### Критерии приемки

1. КОГДА Payment Service подтверждает покупку ТОГДА Library Service ДОЛЖЕН добавить игру в библиотеку за < 100ms
2. КОГДА происходит добавление игры ТОГДА Library Service ДОЛЖЕН валидировать данные покупки
3. КОГДА игра уже в библиотеке ТОГДА Library Service ДОЛЖЕН вернуть ошибку 409
4. ЕСЛИ добавление не удалось ТОГДА Library Service ДОЛЖЕН логировать детальную ошибку

### Требование 5

**Пользовательская история:** Как Game Catalog Service, я хочу предоставлять актуальную информацию об играх для библиотек пользователей.

#### Критерии приемки

1. КОГДА Library Service запрашивает данные игры ТОГДА Game Catalog Service ДОЛЖЕН вернуть информацию за < 50ms
2. КОГДА данные игры обновляются ТОГДА Library Service ДОЛЖЕН инвалидировать кэш
3. КОГДА игра недоступна в каталоге ТОГДА Library Service ДОЛЖЕН показать базовую информацию
4. ЕСЛИ Game Catalog Service недоступен ТОГДА Library Service ДОЛЖЕН работать с кэшированными данными

### Требование 6

**Пользовательская история:** Как система, я хочу использовать общий Redis для кэширования данных между всеми микросервисами.

#### Критерии приемки

1. КОГДА Library Service кэширует данные ТОГДА система ДОЛЖНА использовать общий Redis из docker-compose
2. КОГДА происходит кэширование ТОГДА Library Service ДОЛЖЕН использовать namespace "library:"
3. КОГДА кэш инвалидируется ТОГДА Library Service ДОЛЖЕН уведомлять другие сервисы
4. ЕСЛИ Redis недоступен ТОГДА Library Service ДОЛЖЕН работать без кэширования

### Требование 7

**Пользовательская история:** Как DevOps инженер, я хочу мониторить производительность Library Service и быстро диагностировать проблемы.

#### Критерии приемки

1. КОГДА происходит операция с библиотекой ТОГДА Library Service ДОЛЖЕН логировать метрики производительности
2. КОГДА возникает ошибка ТОГДА Library Service ДОЛЖЕН логировать детальную информацию с correlation ID
3. КОГДА проверяется здоровье сервиса ТОГДА Library Service ДОЛЖЕН проверять подключения к БД, Redis и внешним сервисам
4. ЕСЛИ производительность деградирует ТОГДА Library Service ДОЛЖЕН отправлять алерты

### Требование 8

**Пользовательская история:** Как фронтенд разработчик, я хочу использовать консистентный API для работы с библиотеками после рефакторинга.

#### Критерии приемки

1. КОГДА вызывается любой endpoint ТОГДА Library Service ДОЛЖЕН возвращать стандартизированный формат ответа
2. КОГДА происходит ошибка ТОГДА Library Service ДОЛЖЕН возвращать единообразные коды ошибок
3. КОГДА используется пагинация ТОГДА Library Service ДОЛЖЕН поддерживать стандартные параметры
4. ЕСЛИ требуется фильтрация ТОГДА Library Service ДОЛЖЕН поддерживать query параметры

### Требование 9

**Пользовательская история:** Как часть общей платформы, я хочу чтобы Library Service интегрировался с общим CI/CD процессом.

#### Критерии приемки

1. КОГДА происходит push в репозиторий ТОГДА Library Service ДОЛЖЕН запускать тесты через общий GitHub Actions workflow
2. КОГДА тесты проходят ТОГДА Library Service ДОЛЖЕН автоматически собирать Docker образ
3. КОГДА образ готов ТОГДА Library Service ДОЛЖЕН деплоить в общую инфраструктуру
4. ЕСЛИ тесты не проходят ТОГДА Library Service ДОЛЖЕН блокировать деплой и уведомлять команду

### Требование 10

**Пользовательская история:** Как система безопасности, я хочу чтобы Library Service обеспечивал защиту данных библиотек пользователей.

#### Критерии приемки

1. КОГДА пользователь обращается к чужой библиотеке ТОГДА Library Service ДОЛЖЕН вернуть ошибку 403
2. КОГДА происходит доступ к данным ТОГДА Library Service ДОЛЖЕН логировать все операции с userId
3. КОГДА обнаружена подозрительная активность ТОГДА Library Service ДОЛЖЕН заблокировать доступ
4. ЕСЛИ требуется аудит ТОГДА Library Service ДОЛЖЕН предоставить полные логи операций