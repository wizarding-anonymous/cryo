# Требования к Payment Service

## Введение

Payment Service является критически важным сервисом для обработки платежей российской игровой платформы. Сервис отвечает за интеграцию с российскими платежными системами, обработку транзакций, управление подписками, соблюдение российского законодательства о платежах, защиту от мошенничества и предоставление API для других микросервисов.

## Требования

### Требование 1

**Пользовательская история:** Как пользователь, я хочу покупать игры через российские платежные системы, чтобы безопасно совершать покупки.

#### Критерии приемки

1. КОГДА пользователь выбирает игру для покупки ТОГДА система ДОЛЖНА показать доступные способы оплаты
2. КОГДА пользователь выбирает способ оплаты ТОГДА система ДОЛЖНА перенаправить на платежную систему
3. КОГДА платеж успешно завершен ТОГДА система ДОЛЖНА добавить игру в библиотеку пользователя
4. ЕСЛИ платеж отклонен ТОГДА система ДОЛЖНА показать причину отклонения и предложить альтернативы

### Требование 2

**Пользовательская история:** Как пользователь, я хочу использовать российские платежные системы, чтобы платить привычными способами.

#### Критерии приемки

1. КОГДА пользователь выбирает оплату ТОГДА система ДОЛЖНА поддерживать Сбербанк Онлайн, ЮMoney, QIWI
2. КОГДА пользователь выбирает банковскую карту ТОГДА система ДОЛЖНА поддерживать карты МИР, Visa, Mastercard
3. КОГДА пользователь выбирает мобильные платежи ТОГДА система ДОЛЖНА поддерживать оплату через мобильных операторов
4. ЕСЛИ платежная система недоступна ТОГДА система ДОЛЖНА предложить альтернативные способы

### Требование 3

**Пользовательская история:** Как пользователь, я хочу видеть историю своих покупок и платежей, чтобы контролировать расходы.

#### Критерии приемки

1. КОГДА пользователь открывает историю платежей ТОГДА система ДОЛЖНА показать все транзакции с деталями
2. КОГДА пользователь просматривает покупку ТОГДА система ДОЛЖНА показать дату, сумму, способ оплаты, статус
3. КОГДА пользователь запрашивает чек ТОГДА система ДОЛЖНА предоставить электронный чек
4. ЕСЛИ нужен возврат ТОГДА система ДОЛЖНА позволить подать заявку на возврат

### Требование 4

**Пользовательская история:** Как пользователь, я хочу получать возврат средств за игры, чтобы защитить свои права потребителя.

#### Критерии приемки

1. КОГДА пользователь запрашивает возврат ТОГДА система ДОЛЖНА проверить условия возврата
2. КОГДА возврат одобрен ТОГДА система ДОЛЖНА инициировать возврат средств на исходный способ оплаты
3. КОГДА возврат обрабатывается ТОГДА система ДОЛЖНА уведомить пользователя о статусе
4. ЕСЛИ возврат невозможен ТОГДА система ДОЛЖНА объяснить причины отказа

### Требование 5

**Пользовательская история:** Как система, я должна соблюдать российское законодательство о платежах и налогах.

#### Критерии приемки

1. КОГДА происходит платеж ТОГДА система ДОЛЖНА применить корректную ставку НДС
2. КОГДА формируется чек ТОГДА система ДОЛЖНА соответствовать требованиям 54-ФЗ
3. КОГДА обрабатывается платеж ТОГДА система ДОЛЖНА передавать данные в налоговую через ОФД
4. ЕСЛИ требуется валютное законодательство ТОГДА система ДОЛЖНА соблюдать требования валютного регулирования

### Требование 6

**Пользовательская история:** Как другой микросервис, я хочу инициировать платежи и получать уведомления о статусе, чтобы обновлять состояние заказов.

#### Критерии приемки

1. КОГДА сервис создает платеж ТОГДА система ДОЛЖНА вернуть уникальный ID транзакции
2. КОГДА статус платежа изменяется ТОГДА система ДОЛЖНА отправить событие в Kafka
3. КОГДА сервис запрашивает статус ТОГДА система ДОЛЖНА вернуть актуальную информацию
4. ЕСЛИ платеж завершен ТОГДА система ДОЛЖНА предоставить детали транзакции

### Требование 7

**Пользовательская история:** Как пользователь, я хочу покупать подарки для других пользователей, чтобы делиться играми с друзьями.

#### Критерии приемки

1. КОГДА пользователь выбирает подарок ТОГДА система ДОЛЖНА позволить указать получателя
2. КОГДА подарок оплачен ТОГДА система ДОЛЖНА отправить уведомление получателю
3. КОГДА получатель принимает подарок ТОГДА система ДОЛЖНА добавить игру в его библиотеку
4. ЕСЛИ получатель отклоняет подарок ТОГДА система ДОЛЖНА вернуть средства отправителю

### Требование 8

**Пользовательская история:** Как пользователь, я хочу использовать промокоды и скидки, чтобы покупать игры выгоднее.

#### Критерии приемки

1. КОГДА пользователь вводит промокод ТОГДА система ДОЛЖНА проверить его валидность
2. КОГДА промокод действителен ТОГДА система ДОЛЖНА применить скидку к заказу
3. КОГДА действует сезонная скидка ТОГДА система ДОЛЖНА автоматически применить её
4. ЕСЛИ промокод недействителен ТОГДА система ДОЛЖНА показать соответствующую ошибку

### Требование 9

**Пользовательская история:** Как система, я должна защищать от мошенничества и подозрительных транзакций.

#### Критерии приемки

1. КОГДА происходит подозрительная транзакция ТОГДА система ДОЛЖНА заблокировать её для проверки
2. КОГДА обнаружена попытка мошенничества ТОГДА система ДОЛЖНА заблокировать аккаунт
3. КОГДА происходят множественные неудачные попытки ТОГДА система ДОЛЖНА временно заблокировать карту
4. ЕСЛИ транзакция прошла проверку ТОГДА система ДОЛЖНА разблокировать её

### Требование 10

**Пользовательская история:** Как администратор, я хочу управлять платежами и возвратами, чтобы решать спорные ситуации.

#### Критерии приемки

1. КОГДА администратор просматривает платежи ТОГДА система ДОЛЖНА показать все транзакции с фильтрами
2. КОГДА требуется ручной возврат ТОГДА система ДОЛЖНА позволить инициировать его
3. КОГДА происходит спорная ситуация ТОГДА система ДОЛЖНА предоставить все детали транзакции
4. ЕСЛИ нужна блокировка платежей ТОГДА система ДОЛЖНА позволить заблокировать пользователя

### Требование 11

**Пользовательская история:** Как пользователь, я хочу использовать кошелек платформы для быстрых покупок.

#### Критерии приемки

1. КОГДА пользователь пополняет кошелек ТОГДА система ДОЛЖНА зачислить средства после подтверждения платежа
2. КОГДА пользователь покупает игру ТОГДА система ДОЛЖНА позволить оплату из кошелька
3. КОГДА средств недостаточно ТОГДА система ДОЛЖНА предложить доплатить разницу
4. ЕСЛИ происходит возврат ТОГДА система ДОЛЖНА вернуть средства в кошелек

### Требование 12

**Пользовательская история:** Как система, я должна обеспечивать высокую производительность и доступность платежей.

#### Критерии приемки

1. КОГДА происходит пиковая нагрузка ТОГДА система ДОЛЖНА обрабатывать до 5000 одновременных платежей
2. КОГДА платежная система недоступна ТОГДА время восстановления НЕ ДОЛЖНО превышать 2 минуты
3. КОГДА пользователь инициирует платеж ТОГДА время отклика ДОЛЖНО быть менее 300мс в 95% случаев
4. ЕСЛИ внешняя платежная система недоступна ТОГДА система ДОЛЖНА переключиться на резервную

### Требование 13

**Пользовательская история:** Как пользователь, я хочу покупать подписки на сервисы платформы.

#### Критерии приемки

1. КОГДА пользователь оформляет подписку ТОГДА система ДОЛЖНА настроить автоматические платежи
2. КОГДА подписка продлевается ТОГДА система ДОЛЖНА списать средства и продлить доступ
3. КОГДА пользователь отменяет подписку ТОГДА система ДОЛЖНА остановить автоплатежи
4. ЕСЛИ платеж по подписке не прошел ТОГДА система ДОЛЖНА уведомить пользователя и приостановить подписку

### Требование 14

**Пользовательская история:** Как разработчик, я хочу получать выплаты за продажи своих игр.

#### Критерии приемки

1. КОГДА игра продается ТОГДА система ДОЛЖНА рассчитать долю разработчика
2. КОГДА наступает период выплат ТОГДА система ДОЛЖНА сформировать отчет о доходах
3. КОГДА разработчик запрашивает выплату ТОГДА система ДОЛЖНА инициировать перевод средств
4. ЕСЛИ выплата задерживается ТОГДА система ДОЛЖНА уведомить разработчика о причинах

### Требование 15

**Пользовательская история:** Как система, я должна интегрироваться с банковскими API для прямых переводов.

#### Критерии приемки

1. КОГДА пользователь выбирает банковский перевод ТОГДА система ДОЛЖНА интегрироваться с API банка
2. КОГДА происходит перевод ТОГДА система ДОЛЖНА получить подтверждение от банка
3. КОГДА банк недоступен ТОГДА система ДОЛЖНА предложить альтернативные способы
4. ЕСЛИ перевод отклонен ТОГДА система ДОЛЖНА показать причину от банка

### Требование 16

**Пользовательская история:** Как пользователь, я хочу видеть курсы валют и платить в удобной валюте.

#### Критерии приемки

1. КОГДА отображается цена ТОГДА система ДОЛЖНА показать стоимость в рублях и других валютах
2. КОГДА изменяется курс ТОГДА система ДОЛЖНА обновить цены в реальном времени
3. КОГДА пользователь выбирает валюту ТОГДА система ДОЛЖНА пересчитать итоговую сумму
4. ЕСЛИ курс сильно изменился ТОГДА система ДОЛЖНА предупредить пользователя

### Требование 17

**Пользовательская история:** Как система, я должна обеспечивать безопасность платежных данных.

#### Критерии приемки

1. КОГДА обрабатываются платежные данные ТОГДА система ДОЛЖНА использовать PCI DSS стандарты
2. КОГДА сохраняется информация о карте ТОГДА система ДОЛЖНА токенизировать данные
3. КОГДА передаются данные ТОГДА система ДОЛЖНА использовать end-to-end шифрование
4. ЕСЛИ обнаружена утечка ТОГДА система ДОЛЖНА немедленно заблокировать скомпрометированные данные

### Требование 18

**Пользовательская история:** Как аудитор, я хочу отслеживать все финансовые операции для соответствия требованиям.

#### Критерии приемки

1. КОГДА происходит платеж ТОГДА система ДОЛЖНА записать полный аудит-лог транзакции
2. КОГДА изменяется статус платежа ТОГДА система ДОЛЖНА зафиксировать изменение с временной меткой
3. КОГДА требуется отчет ТОГДА система ДОЛЖНА предоставить детальную финансовую отчетность
4. ЕСЛИ происходит подозрительная активность ТОГДА система ДОЛЖНА создать алерт для проверки

### Требование 19

**Пользовательская история:** Как пользователь, я хочу получать уведомления о всех финансовых операциях.

#### Критерии приемки

1. КОГДА происходит списание ТОГДА система ДОЛЖНА отправить SMS и email уведомление
2. КОГДА платеж завершен ТОГДА система ДОЛЖНА отправить подтверждение с чеком
3. КОГДА происходит возврат ТОГДА система ДОЛЖНА уведомить о зачислении средств
4. ЕСЛИ обнаружена подозрительная активность ТОГДА система ДОЛЖНА немедленно уведомить пользователя

### Требование 20

**Пользовательская история:** Как система, я должна поддерживать различные модели ценообразования игр.

#### Критерии приемки

1. КОГДА игра имеет фиксированную цену ТОГДА система ДОЛЖНА обрабатывать разовые платежи
2. КОГДА игра free-to-play с микротранзакциями ТОГДА система ДОЛЖНА поддерживать внутриигровые покупки
3. КОГДА игра по подписке ТОГДА система ДОЛЖНА обрабатывать рекуррентные платежи
4. ЕСЛИ игра имеет сезонный пропуск ТОГДА система ДОЛЖНА поддерживать предзаказы и рассрочку

### Требование 21: Система купонов и промокодов

**Пользовательская история:** Как пользователь, я хочу использовать различные типы купонов для получения скидок при покупке игр.

#### Критерии приемки

1. КОГДА пользователь применяет купон ТОГДА система ДОЛЖНА проверить его валидность и применимость к товарам в корзине
2. КОГДА купон валиден ТОГДА система ДОЛЖНА рассчитать скидку согласно типу купона (процентная, фиксированная, BOGO)
3. КОГДА применяется несколько купонов ТОГДА система ДОЛЖНА проверить правила стекинга и применить максимально выгодную комбинацию
4. КОГДА купон имеет ограничения ТОГДА система ДОЛЖНА проверить минимальную сумму покупки и категории товаров
5. ЕСЛИ купон персональный ТОГДА система ДОЛЖНА ограничить его использование только этим пользователем

### Требование 22: Система подарочных карт

**Пользовательская история:** Как пользователь, я хочу покупать и использовать подарочные карты для оплаты игр и подарков друзьям.

#### Критерии приемки

1. КОГДА пользователь покупает подарочную карту ТОГДА система ДОЛЖНА генерировать уникальный 16-значный код
2. КОГДА карта активируется ТОГДА система ДОЛЖНА зачислить средства на баланс получателя
3. КОГДА используется подарочная карта ТОГДА система ДОЛЖНА списывать средства с баланса карты
4. КОГДА создается корпоративная подарочная карта ТОГДА система ДОЛЖНА применять объемные скидки и поддерживать кастомный брендинг
5. ЕСЛИ баланс карты недостаточен ТОГДА система ДОЛЖНА позволить доплатить разницу другим способом

### Требование 23: Система региональных цен

**Пользовательская история:** Как пользователь из определенного региона, я хочу видеть цены в местной валюте с учетом региональных особенностей.

#### Критерии приемки

1. КОГДА определяется регион пользователя ТОГДА система ДОЛЖНА применить соответствующие региональные цены
2. КОГДА отображается цена ТОГДА система ДОЛЖНА показывать стоимость в местной валюте с учетом налогов
3. КОГДА обновляются курсы валют ТОГДА система ДОЛЖНА автоматически пересчитывать региональные цены
4. КОГДА пользователь пытается обойти региональные ограничения ТОГДА система ДОЛЖНА блокировать такие попытки
5. ЕСЛИ региональная цена недоступна ТОГДА система ДОЛЖНА использовать глобальную цену в USD

### Требование 24: Система донатов стримерам

**Пользовательская история:** Как зритель стрима, я хочу отправлять донаты стримерам в реальном времени с различными типами поддержки.

#### Критерии приемки

1. КОГДА зритель отправляет донат ТОГДА система ДОЛЖНА мгновенно обработать платеж и уведомить стримера
2. КОГДА обрабатывается донат ТОГДА система ДОЛЖНА поддерживать денежные донаты, виртуальные подарки и игровые ключи
3. КОГДА рассчитывается комиссия ТОГДА система ДОЛЖНА удерживать 15% для платформы и 85% передавать стримеру
4. КОГДА наступает период выплат ТОГДА система ДОЛЖНА автоматически переводить накопленные средства стримеру еженедельно
5. ЕСЛИ донат содержит неподходящее сообщение ТОГДА система ДОЛЖНА фильтровать контент перед отображением

### Требование 25: Обработка реферальных выплат

**Пользовательская история:** Как участник реферальной программы, я хочу получать финансовые вознаграждения, обработанные через надежную платежную систему.

#### Критерии приемки

1. КОГДА Social Service отправляет запрос на реферальную выплату ТОГДА система ДОЛЖНА валидировать запрос и обработать платеж
2. КОГДА обрабатывается реферальная выплата ТОГДА система ДОЛЖНА поддерживать различные способы: зачисление на баланс, банковский перевод, электронные кошельки
3. КОГДА выплата завершена ТОГДА система ДОЛЖНА отправить подтверждение обратно в Social Service и уведомить получателя
4. КОГДА происходит ошибка выплаты ТОГДА система ДОЛЖНА уведомить Social Service для повторной попытки или корректировки
5. ЕСЛИ Social Service запрашивает отмену выплаты ТОГДА система ДОЛЖНА заблокировать или вернуть средства согласно политике

### Требование 26: Система предзаказных платежей

**Пользовательская история:** Как покупатель предзаказа, я хочу гибкие варианты оплаты с возможностью отмены до релиза игры.

#### Критерии приемки

1. КОГДА оформляется предзаказ ТОГДА система ДОЛЖНА поддерживать частичную предоплату или полную оплату
2. КОГДА игра выходит ТОГДА система ДОЛЖНА автоматически списать остаток суммы при частичной предоплате
3. КОГДА пользователь отменяет предзаказ ТОГДА система ДОЛЖНА вернуть все средства до даты релиза
4. КОГДА применяются предзаказные скидки ТОГДА система ДОЛЖНА зафиксировать льготную цену на момент заказа
5. ЕСЛИ релиз игры откладывается ТОГДА система ДОЛЖНА уведомить покупателей и предложить отмену с возвратом

### Требование 27: Обработка донатов стримерам

**Пользовательская история:** Как зритель стрима, я хочу безопасно отправлять донаты стримерам через надежную платежную систему.

#### Критерии приемки

1. КОГДА Streaming Service отправляет запрос на донат ТОГДА система ДОЛЖНА валидировать данные и обработать платеж в реальном времени
2. КОГДА обрабатывается донат ТОГДА система ДОЛЖНА поддерживать различные типы: денежные переводы, покупка виртуальных подарков, оплата игровых предметов
3. КОГДА донат успешно обработан ТОГДА система ДОЛЖНА мгновенно уведомить Streaming Service для отображения в стриме
4. КОГДА рассчитываются выплаты стримерам ТОГДА система ДОЛЖНА применять комиссию платформы и переводить средства согласно настройкам стримера
5. ЕСЛИ происходит chargeback или возврат ТОГДА система ДОЛЖНА уведомить Streaming Service и скорректировать баланс стримера