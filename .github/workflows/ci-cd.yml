name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run unit tests
      run: npm run test

    - name: Security scan
      run: |
        echo "ğŸ” Running security scan..."
        npm audit --audit-level high
        echo "âœ… Security scan completed"

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        echo "ğŸ³ Building Docker image..."
        echo "docker build -t user-service:${{ github.sha }} ."
        echo "âœ… Docker image built successfully"

    - name: Push to registry
      run: |
        echo "ğŸ“¤ Pushing image to registry..."
        echo "docker push user-service:${{ github.sha }}"
        echo "âœ… Image pushed to registry"

  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    steps:
    - name: Deploy to staging
      run: |
        echo "ğŸš€ Deploying to staging environment..."
        echo "kubectl set image deployment/user-service user-service=user-service:${{ github.sha }}"
        echo "âœ… Deployed to staging successfully"

  deploy-production:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Deploy to production
      run: |
        echo "ğŸš€ Deploying to production environment..."
        echo "helm upgrade user-service ./helm/user-service --set image.tag=${{ github.sha }}"
        echo "âœ… Deployed to production successfully"
